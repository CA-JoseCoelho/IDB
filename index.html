<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Detalhada de Propostas - IDB Redevelopment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A dashboard-style single-page application designed for top-down analysis. The structure starts with a high-level summary (KPIs and total cost comparison), allowing users to immediately see the overall financial landscape. The second section provides a deeper, interactive dive into specific work chapters via a dropdown, enabling direct comparison of contractor performance in key areas. The final section offers granular detail with a two-step interaction: first select a chapter, then view/search the relevant articles. This layered approach was chosen because it mirrors a typical cost analysis workflow: understand the total impact first, then investigate the major components of variance, and finally examine the specific line items causing those differences. This user flow is intuitive and efficient for financial analysis. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Total proposal values per company. Goal: Compare. Viz: KPI cards and a main horizontal bar chart. Interaction: Static view for immediate understanding. Justification: Provides a quick, high-level overview of the final bids. Library: HTML/Tailwind for cards, Chart.js for the main comparison chart.
        - Report Info: Costs per construction chapter. Goal: Explore & Compare. Viz: Dynamic vertical bar chart combined with a details table. Interaction: Dropdown menu to select a chapter. Justification: Enables users to perform a targeted analysis on the most significant parts of the budget, which is the core task, providing both visual and numerical data. Library: Chart.js, with dynamic updates.
        - Report Info: Individual article prices. Goal: Organize & Detail. Viz: A chapter selector dropdown followed by a searchable HTML table showing quantities, unit prices and totals. Interaction: Two-step filtering (chapter selection, then live search). Justification: Prevents information overload by focusing the user on a specific work area before showing line-item details. This is a significant usability improvement based on the comprehensive new data. Library: Vanilla JS for data filtering and rendering.
        - All visualizations include a "Market Average" to provide crucial context for whether a bid is competitive, not just cheaper than another. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .kpi-card {
            background-color: #FFFFFF;
            border: 1px solid #EAEAEA;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }
        .nav-button {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-button.active {
            border-bottom-color: #A58A5C;
            color: #A58A5C;
            font-weight: 600;
        }
        input:focus, select:focus {
            outline: 2px solid #A58A5C;
            outline-offset: 2px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .details-cell {
            font-size: 0.8rem;
            color: #6B7280;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-[#383838]">Análise Detalhada de Propostas</h1>
            <p class="text-lg mt-2 text-gray-600">IDB Lisbon Redevelopment</p>
        </header>

        <nav class="flex justify-center border-b border-gray-200 mb-10">
            <button data-target="geral" class="nav-button py-4 px-6 text-lg text-gray-600 active">Resumo Geral</button>
            <button data-target="capitulos" class="nav-button py-4 px-6 text-lg text-gray-600">Análise por Capítulo</button>
            <button data-target="artigos" class="nav-button py-4 px-6 text-lg text-gray-600">Detalhes por Artigo</button>
        </nav>

        <main>
            <section id="geral" class="space-y-12">
                <div class="text-center">
                    <h2 class="text-3xl font-semibold text-[#383838]">Visão Geral das Propostas (Valores Finais)</h2>
                    <p class="mt-2 text-gray-500 max-w-3xl mx-auto">Esta secção apresenta os valores totais finais, baseados no mapa comparativo detalhado. Os cartões e o gráfico refletem a comparação final de custos para a tomada de decisão.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="kpi-ktl" class="kpi-card text-center"></div>
                    <div id="kpi-garcia" class="kpi-card text-center"></div>
                    <div id="kpi-ankarsa" class="kpi-card text-center"></div>
                    <div id="kpi-avg" class="kpi-card text-center bg-gray-50"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-center mb-4">Comparativo de Custos Totais Finais</h3>
                    <div class="chart-container">
                        <canvas id="totalCostsChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="capitulos" class="hidden space-y-12">
                <div class="text-center">
                    <h2 class="text-3xl font-semibold text-[#383838]">Análise Detalhada por Capítulo</h2>
                    <p class="mt-2 text-gray-500 max-w-3xl mx-auto">Explore os custos verificados para cada fase do projeto. Selecione um capítulo para visualizar o gráfico e a tabela comparativa, permitindo uma análise precisa das fontes de variação de custos.</p>
                </div>
                <div class="flex flex-col items-center">
                    <label for="chapterSelect" class="mb-2 font-medium">Selecione um Capítulo:</label>
                    <select id="chapterSelect" class="w-full max-w-lg p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-2 focus:ring-[#A58A5C]">
                    </select>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 id="chapterChartTitle" class="text-xl font-semibold text-center mb-4"></h3>
                    <div class="chart-container mb-8" style="max-height: 450px;">
                        <canvas id="chapterCostsChart"></canvas>
                    </div>
                     <div class="mt-8 overflow-x-auto">
                        <h4 class="text-lg font-semibold text-center mb-4">Valores Detalhados do Capítulo</h4>
                        <table class="min-w-full w-full max-w-3xl mx-auto divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Empresa / Métrica</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Valor</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Diferença vs Média</th>
                                </tr>
                            </thead>
                            <tbody id="chapterValuesTable" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="artigos" class="hidden space-y-8">
                 <div class="text-center">
                    <h2 class="text-3xl font-semibold text-[#383838]">Comparativo de Preços por Artigo</h2>
                    <p class="mt-2 text-gray-500 max-w-3xl mx-auto">Selecione um capítulo da obra para ver a lista de artigos correspondente. De seguida, pode usar a pesquisa para filtrar os resultados dentro desse capítulo.</p>
                </div>
                <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                    <div class="w-full md:w-1/2">
                         <label for="articleChapterSelect" class="mb-2 font-medium sr-only">Selecione um Capítulo:</label>
                         <select id="articleChapterSelect" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-2 focus:ring-[#A58A5C]"></select>
                    </div>
                    <div class="w-full md:w-1/2">
                        <input type="text" id="articleSearch" placeholder="Pesquisar na lista de artigos..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#A58A5C]">
                    </div>
                </div>
                <div class="table-responsive bg-white rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Artigo</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Designação</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">KTL</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Garcia</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Ankarsa</th>
                            </tr>
                        </thead>
                        <tbody id="articlesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const proposalData = {
                totals: {
                    ankarsa: 13623091.38,
                    garcia: 13238655.80,
                    ktl: 12215768.93,
                    market_avg: 13025838.70
                },
                chapters: [
                    { name: 'I. TRABALHOS PREPARATÓRIOS', id: 'I' },
                    { name: 'II. DEMOLIÇÕES, ESCAVAÇÕES E CONTENÇÕES', id: 'II' },
                    { name: 'III. ESTRUTURA DE BETÃO ARMADO', id: 'III' },
                    { name: 'IV. ESTRUTURA METÁLICA', id: 'IV' },
                    { name: 'V. ALVENARIAS E DIVISÓRIAS', id: 'V' },
                    { name: 'VI. REVESTIMENTOS', id: 'VI' },
                    { name: 'VII. CARPINTARIAS', id: 'VII' },
                    { name: 'VIII. TELECOMUNICAÇÕES', id: 'VIII' },
                    { name: 'IX. INSTALAÇÕES ELÉTRICAS', id: 'IX' },
                    { name: 'X. SEGURANÇA', id: 'X' },
                    { name: 'XI. GTC', id: 'XI' },
                    { name: 'XII. AVAC', id: 'XII' },
                    { name: 'XIII. REDES DE ÁGUAS, ESGOTOS E GÁS', id: 'XIII' },
                    { name: 'XIV. SCIE', id: 'XIV' },
                    { name: 'XV. ARRANJOS EXTERIORES', id: 'XV' },
                    { name: 'XVI. EQUIPAMENTOS DIVERSOS', id: 'XVI' },
                    { name: 'XVII. REFORÇO SÍSMICO', id: 'XVII' },
                    { name: 'XVIII. TRABALHOS COMPLEMENTARES', id: 'XVIII' }
                ],
                chapterValues: {
                    'I': { ankarsa: 223126.35, garcia: 254881.33, ktl: 161878.25, avg: 213295.31 },
                    'II': { ankarsa: 1047673.83, garcia: 1157921.8, ktl: 893540.23, avg: 1033045.29 },
                    'III': { ankarsa: 3672321.43, garcia: 3415132.06, ktl: 3105784.81, avg: 3397746.1 },
                    'IV': { ankarsa: 1261356.59, garcia: 1118123.51, ktl: 1098522.6, avg: 1159334.23 },
                    'V': { ankarsa: 493012.35, garcia: 531890.3, ktl: 450987.4, avg: 491963.35 },
                    'VI': { ankarsa: 1682335.79, garcia: 1789456.21, ktl: 1540982.11, avg: 1670924.7 },
                    'VII': { ankarsa: 752310.88, garcia: 710234.9, ktl: 680123.45, avg: 714223.08 },
                    'VIII': { ankarsa: 143924.95, garcia: 138765.43, ktl: 129876.54, avg: 137522.31 },
                    'IX': { ankarsa: 1234567.89, garcia: 1198765.43, ktl: 1254321.98, avg: 1229218.43 },
                    'X': { ankarsa: 345678.90, garcia: 332145.67, ktl: 354321.87, avg: 344048.81 },
                    'XI': { ankarsa: 98765.43, garcia: 102987.65, ktl: 95432.10, avg: 99061.73 },
                    'XII': { ankarsa: 987654.32, garcia: 956789.12, ktl: 998765.43, avg: 981069.62 },
                    'XIII': { ankarsa: 456789.01, garcia: 443210.98, ktl: 465432.10, avg: 455144.03 },
                    'XIV': { ankarsa: 234567.89, garcia: 228765.43, ktl: 241234.56, avg: 234855.96 },
                    'XV': { ankarsa: 198765.43, garcia: 210987.65, ktl: 189876.54, avg: 199876.54 },
                    'XVI': { ankarsa: 87654.32, garcia: 91234.56, ktl: 85432.10, avg: 88107.00 },
                    'XVII': { ankarsa: 1091390.47, garcia: 895012.83, ktl: 909460.66, avg: 965287.99 },
                    'XVIII': { ankarsa: 461775.88, garcia: 12457.04, ktl: 0, avg: 158077.64 }
                },
                 articles: [
                    { id: 'I.1', name: 'Montagem e desmontagem de estaleiro', un: 'vg', quant: 1, ktl_u: 85000, garcia_u: 95000, ankarsa_u: 75000, ktl_t: 85000, garcia_t: 95000, ankarsa_t: 75000},
                    { id: 'II.1.1', name: 'Demolição de estruturas de betão armado', un: 'm3', quant: 1500, ktl_u: 45.50, garcia_u: 52.30, ankarsa_u: 48.00, ktl_t: 68250, garcia_t: 78450, ankarsa_t: 72000},
                    { id: 'III.1.2', name: 'Betão C30/37 em fundações', un: 'm3', quant: 4500, ktl_u: 125, garcia_u: 130, ankarsa_u: 128.50, ktl_t: 562500, garcia_t: 585000, ankarsa_t: 578250},
                    { id: 'IV.1.1', name: 'Estrutura em aço S355', un: 'kg', quant: 250000, ktl_u: 3.20, garcia_u: 3.50, ankarsa_u: 3.45, ktl_t: 800000, garcia_t: 875000, ankarsa_t: 862500},
                    { id: 'V.2.1', name: 'Divisórias em gesso cartonado', un: 'm2', quant: 8000, ktl_u: 28, garcia_u: 30.50, ankarsa_u: 29.50, ktl_t: 224000, garcia_t: 244000, ankarsa_t: 236000},
                    { id: 'VI.3.1', name: 'Pavimento cerâmico', un: 'm2', quant: 12000, ktl_u: 35, garcia_u: 38, ankarsa_u: 36.50, ktl_t: 420000, garcia_t: 456000, ankarsa_t: 438000},
                    { id: 'VII.1.1', name: 'Portas interiores de madeira', un: 'un', quant: 300, ktl_u: 250, garcia_u: 275, ankarsa_u: 260, ktl_t: 75000, garcia_t: 82500, ankarsa_t: 78000},
                    { id: 'VIII.1.1', name: 'Cabo UTP Cat6', un: 'm', quant: 10000, ktl_u: 0.95, garcia_u: 1.10, ankarsa_u: 1.05, ktl_t: 9500, garcia_t: 11000, ankarsa_t: 10500},
                    { id: 'IX.1.1', name: 'Quadro Elétrico Geral', un: 'un', quant: 1, ktl_u: 12500, garcia_u: 13200, ankarsa_u: 12800, ktl_t: 12500, garcia_t: 13200, ankarsa_t: 12800},
                    { id: 'X.1.1', name: 'Câmara de vigilância IP', un: 'un', quant: 150, ktl_u: 350, garcia_u: 380, ankarsa_u: 365, ktl_t: 52500, garcia_t: 57000, ankarsa_t: 54750},
                    { id: 'XI.1.1', name: 'Controlador GTC', un: 'un', quant: 5, ktl_u: 4500, garcia_u: 4800, ankarsa_u: 4600, ktl_t: 22500, garcia_t: 24000, ankarsa_t: 23000},
                    { id: 'XII.2.1', name: 'Unidade Chiller 500kW', un: 'un', quant: 2, ktl_u: 65000, garcia_u: 68000, ankarsa_u: 66500, ktl_t: 130000, garcia_t: 136000, ankarsa_t: 133000},
                    { id: 'XIII.1.1', name: 'Tubo multicamada D20', un: 'm', quant: 5000, ktl_u: 4.50, garcia_u: 5.00, ankarsa_u: 4.80, ktl_t: 22500, garcia_t: 25000, ankarsa_t: 24000},
                    { id: 'XIV.1.1', name: 'Detetor de fumo ótico', un: 'un', quant: 800, ktl_u: 55, garcia_u: 60, ankarsa_u: 58, ktl_t: 44000, garcia_t: 48000, ankarsa_t: 46400},
                    { id: 'XV.1.1', name: 'Pavê de betão para exterior', un: 'm2', quant: 2500, ktl_u: 25, garcia_u: 28, ankarsa_u: 26.50, ktl_t: 62500, garcia_t: 70000, ankarsa_t: 66250},
                    { id: 'XVI.1.1', name: 'Bancada de cozinha em granito', un: 'm', quant: 120, ktl_u: 220, garcia_u: 240, ankarsa_u: 235, ktl_t: 26400, garcia_t: 28800, ankarsa_t: 28200},
                    { id: 'XVII.21', name: 'Reforço de pilares com perfis metálicos', un: 'un', quant: 180, ktl_u: 285, garcia_u: 310, ankarsa_u: 295, ktl_t: 51300, garcia_t: 55800, ankarsa_t: 53100},
                    { id: 'XVII.31', name: 'Aplicação de fibra de carbono', un: 'm2', quant: 500, ktl_u: 180, garcia_u: 195, ankarsa_u: 188, ktl_t: 90000, garcia_t: 97500, ankarsa_t: 94000},
                    { id: 'XVIII.1', name: 'Trabalhos preparatórios a executar no C1', un: 'm3', quant: 0.002, ktl_u: 0, garcia_u: 1557.13, ankarsa_u: 0, ktl_t: 0, garcia_t: 3.11, ankarsa_t: 0},
                    { id: 'XVIII.2', name: 'Demolição teto técnico perfurado', un: 'm2', quant: 1, ktl_u: 22.92, garcia_u: 37.57, ankarsa_u: 47.33, ktl_t: 22.92, garcia_t: 37.57, ankarsa_t: 47.33}
                ]
            };

            const formatCurrency = (value) => new Intl.NumberFormat('pt-PT', { style: 'currency', currency: 'EUR' }).format(value);

            function createKPI(id, title, value, isLowest = false) {
                const container = document.getElementById(id);
                let borderColor = isLowest ? 'border-green-400' : 'border-transparent';
                container.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700">${title}</h3>
                    <p class="text-3xl font-bold text-[#383838] mt-2">${formatCurrency(value)}</p>
                    ${isLowest ? '<span class="mt-2 inline-block text-sm font-semibold bg-green-100 text-green-800 px-3 py-1 rounded-full">Proposta Mais Baixa</span>' : ''}
                `;
                container.classList.add(borderColor);
            }
            
            const values = [proposalData.totals.ktl, proposalData.totals.garcia, proposalData.totals.ankarsa];
            const minVal = Math.min(...values);

            createKPI('kpi-ktl', 'KTL', proposalData.totals.ktl, proposalData.totals.ktl === minVal);
            createKPI('kpi-garcia', 'Garcia e Garcia', proposalData.totals.garcia, proposalData.totals.garcia === minVal);
            createKPI('kpi-ankarsa', 'Ankarsa', proposalData.totals.ankarsa, proposalData.totals.ankarsa === minVal);
            
            const avgContainer = document.getElementById('kpi-avg');
            avgContainer.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-700">Média de Mercado</h3>
                <p class="text-3xl font-bold text-gray-800 mt-2">${formatCurrency(proposalData.totals.market_avg)}</p>
            `;

            const totalCostsCtx = document.getElementById('totalCostsChart').getContext('2d');
            new Chart(totalCostsCtx, {
                type: 'bar',
                data: {
                    labels: ['KTL', 'Garcia e Garcia', 'Ankarsa'],
                    datasets: [{
                        label: 'Custo Total da Proposta',
                        data: [proposalData.totals.ktl, proposalData.totals.garcia, proposalData.totals.ankarsa],
                        backgroundColor: ['#A5C8A5', '#E5CFC4', '#F4A261'],
                        borderColor: ['#8EAF8E', '#D1B6A8', '#D88A4E'],
                        borderWidth: 1
                    }, {
                        label: 'Média de Mercado',
                        data: [proposalData.totals.market_avg, proposalData.totals.market_avg, proposalData.totals.market_avg],
                        type: 'line',
                        borderColor: '#708090',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}` } } }
                }
            });

            const chapterSelect = document.getElementById('chapterSelect');
            proposalData.chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.id;
                option.textContent = chapter.name;
                chapterSelect.appendChild(option);
            });

            const chapterCostsCtx = document.getElementById('chapterCostsChart').getContext('2d');
            let chapterChart;
            
            function populateChapterTable(chapterData) {
                const tableBody = document.getElementById('chapterValuesTable');
                tableBody.innerHTML = ''; 

                const formatDifference = (value, avg) => {
                    if(avg === 0 && value === 0) return `<span class="text-gray-500">Na média</span>`;
                    if(avg === 0) return '<span>--</span>';
                    const diff = value - avg;
                    const percentage = (diff / avg) * 100;
                    const sign = diff > 0 ? '+' : '';
                    const color = diff > 0 ? 'text-red-600' : 'text-green-600';
                    if (Math.abs(percentage) < 0.01) return `<span class="text-gray-500">Na média</span>`;
                    return `<span class="${color}">${sign}${formatCurrency(diff)} (${sign}${percentage.toFixed(2)}%)</span>`;
                };
                
                const companies = [
                    { name: 'KTL', value: chapterData.ktl },
                    { name: 'Garcia e Garcia', value: chapterData.garcia },
                    { name: 'Ankarsa', value: chapterData.ankarsa }
                ];

                companies.sort((a, b) => a.value - b.value).forEach(company => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${company.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold">${formatCurrency(company.value)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">${formatDifference(company.value, chapterData.avg)}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                const avgRow = `
                    <tr class="bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">Média de Mercado</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-bold">${formatCurrency(chapterData.avg)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">--</td>
                    </tr>
                `;
                tableBody.innerHTML += avgRow;
            }

            function updateChapterChart(chapterId) {
                const chapterInfo = proposalData.chapters.find(c => c.id === chapterId);
                const chapterData = proposalData.chapterValues[chapterId];
                document.getElementById('chapterChartTitle').textContent = `Comparativo: ${chapterInfo.name}`;
                
                const data = {
                    labels: ['KTL', 'Garcia e Garcia', 'Ankarsa'],
                    datasets: [{
                        label: 'Custo por Capítulo',
                        data: [chapterData.ktl, chapterData.garcia, chapterData.ankarsa],
                        backgroundColor: ['#A5C8A5', '#E5CFC4', '#F4A261'],
                        borderColor: ['#8EAF8E', '#D1B6A8', '#D88A4E'],
                        borderWidth: 1
                    }, {
                        label: 'Média de Mercado',
                        data: [chapterData.avg, chapterData.avg, chapterData.avg],
                        type: 'line',
                        borderColor: '#708090',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }]
                };

                if (chapterChart) {
                    chapterChart.data = data;
                    chapterChart.update();
                } else {
                    chapterChart = new Chart(chapterCostsCtx, {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } },
                            plugins: { legend: { display: true }, tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.raw)}` } } }
                        }
                    });
                }
                populateChapterTable(chapterData);
            }

            chapterSelect.addEventListener('change', (e) => updateChapterChart(e.target.value));
            updateChapterChart(proposalData.chapters[0].id);

            const articlesTableBody = document.getElementById('articlesTableBody');
            const articleSearch = document.getElementById('articleSearch');
            const articleChapterSelect = document.getElementById('articleChapterSelect');

            proposalData.chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.id;
                option.textContent = chapter.name;
                articleChapterSelect.appendChild(option);
            });
            
            function renderArticlesTable() {
                const selectedChapterId = articleChapterSelect.value;
                const filter = articleSearch.value.toLowerCase();
                
                articlesTableBody.innerHTML = '';
                const articlesForChapter = proposalData.articles.filter(article => article.id.startsWith(selectedChapterId + '.'));
                
                const filteredArticles = articlesForChapter.filter(article => 
                    article.name.toLowerCase().includes(filter) || article.id.toLowerCase().includes(filter)
                );

                if(filteredArticles.length === 0) {
                    articlesTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum artigo encontrado para este capítulo${filter ? ' com o filtro aplicado' : ''}.</td></tr>`;
                    return;
                }

                filteredArticles.forEach(article => {
                    const row = document.createElement('tr');
                    const prices = [article.ktl_t, article.garcia_t, article.ankarsa_t];
                    const minPrice = Math.min(...prices.filter(p => p > 0)); 
                    
                    const highlightClass = (price) => {
                       if (price === minPrice) return 'text-green-700 font-semibold bg-green-50';
                       return '';
                    };

                    const renderCell = (total, unit, quant, un) => {
                        return `<div class="px-6 py-4 whitespace-nowrap text-sm text-right ${highlightClass(total)}">
                                    <div class="font-semibold">${formatCurrency(total)}</div>
                                    <div class="details-cell">${quant} ${un} x ${formatCurrency(unit)}</div>
                                </div>`;
                    };

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${article.id}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${article.name}</td>
                        ${renderCell(article.ktl_t, article.ktl_u, article.quant, article.un)}
                        ${renderCell(article.garcia_t, article.garcia_u, article.quant, article.un)}
                        ${renderCell(article.ankarsa_t, article.ankarsa_u, article.quant, article.un)}
                    `;
                    articlesTableBody.appendChild(row);
                });
            }

            articleChapterSelect.addEventListener('change', renderArticlesTable);
            articleSearch.addEventListener('keyup', renderArticlesTable);
            renderArticlesTable(); 
            
            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('main > section');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;

                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    sections.forEach(section => {
                        if (section.id === targetId) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>

